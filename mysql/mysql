CREATE DATABASE IF NOT EXISTS `merchsystem`;

USE `merchsystem`;

CREATE TABLE `users` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(255) NOT NULL,
  `email_address` VARCHAR(255) NOT NULL UNIQUE,
  `password_hash` VARCHAR(255) NOT NULL,
  `otp` VARCHAR(6) NULL,
  `otp_generated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `is_verified` TINYINT(1) NOT NULL DEFAULT 0,
  `reset_token_hash` VARCHAR(64) NULL,
  `reset_token_expires_at` DATETIME NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;





-- 1. Create the products table
CREATE TABLE IF NOT EXISTS products (
    product_id VARCHAR(10) PRIMARY KEY,
    productName VARCHAR(255) NOT NULL,
    categories VARCHAR(255),
    price DECIMAL(10, 2) NOT NULL,
    product_Image VARCHAR(255),
    stock INT DEFAULT NULL,  -- Allow stock to be NULL
    size_M INT DEFAULT NULL, -- Allow size_M to be NULL
    size_X INT DEFAULT NULL, -- Allow size_X to be NULL
    size_XL INT DEFAULT NULL, -- Allow size_XL to be NULL
    product_description TEXT
);

-- 2. Create the product_id_sequence table
CREATE TABLE IF NOT EXISTS product_id_sequence (
    id INT AUTO_INCREMENT PRIMARY KEY
);

-- 3. Create the trigger
DELIMITER $$

CREATE TRIGGER before_insert_products
BEFORE INSERT ON products
FOR EACH ROW
BEGIN
    DECLARE new_id INT;
    INSERT INTO product_id_sequence () VALUES ();
    SET new_id = LAST_INSERT_ID();
    SET NEW.product_id = CONCAT('P', LPAD(new_id, 5, '0'));
END $$

DELIMITER ;
